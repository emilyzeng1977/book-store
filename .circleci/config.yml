version: 2.1

executors:
  docker-executor:
    docker:
      - image: cimg/python:3.12

jobs:
  build:
    executor: docker-executor
    steps:
      - checkout
      - run:
          name: Dummy build step
          command: echo "Build complete"

  approve-to-push-image:
    executor: docker-executor
    steps:
      - run:
          name: Manual approval before push image
          command: echo "Manual approval to push image"

  push-image:
    executor: docker-executor
    steps:
      - run:
          name: Dummy Image Build and Push
          command: echo "Build and push Docker image placeholder"

  approve-to-create-release-branch:
    executor: docker-executor
    steps:
      - run:
          name: Manual approval before releasing
          command: echo "Manual approval to release required"

  create-release-branch:
    executor: docker-executor
    environment:
      VERSION_FILE: app/backend/book-store/version.txt
    steps:
      - checkout

      - run:
          name: Install bump2version
          command: |
            pip install bump2version

      - run:
          name: Get release version (strip -SNAPSHOT)
          command: |
            VERSION=$(<"$VERSION_FILE")
            RELEASE_VERSION="${VERSION%-SNAPSHOT}"
            echo "export VERSION=$VERSION" >> "$BASH_ENV"
            echo "export RELEASE_VERSION=$RELEASE_VERSION" >> "$BASH_ENV"

      - run:
          name: Configure Git user and remote
          command: |
            source "$BASH_ENV"
            git config user.email "ci@example.com"
            git config user.name "CircleCI"
            git remote set-url origin https://${GIT_AUTH_TOKEN}@github.com/emilyzeng1977/book-store.git

      - run:
          name: Checkout release branch from develop
          command: |
            source "$BASH_ENV"
            git fetch origin
            git checkout -b release/$RELEASE_VERSION origin/develop

      - run:
          name: Bump version and push release branch
          command: |
            source "$BASH_ENV"
            bump2version --new-version ${RELEASE_VERSION}-RC --verbose
            git add .
            git commit -m "chore: bump version to ${RELEASE_VERSION}-RC"
            git push origin release/$RELEASE_VERSION

workflows:
  version: 2
  release-flow:
    jobs:
      - build
      - approve-to-push-image:
          type: approval
      - push-image:
          requires:
            - build
            - approve-to-push-image
      - approve-to-create-release-branch:
          type: approval
      - create-release-branch:
          requires:
            - approve-to-create-release-branch
          filters:
            branches:
              only:
                - develop