name: Build

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  build_image:
    name: Build Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_HUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

      - name: Generate image
        run: |
          cd app/backend/book-store
          docker build -t zengemily79/book_store:${{ github.sha }} .
          docker tag zengemily79/book_store:${{ github.sha }} zengemily79/book_store:latest

  wait_for_approval:
    name: Wait for Manual Approval
    runs-on: ubuntu-latest
    needs: build_image
    if: github.event_name == 'pull_request'  # 只有在 PR 事件下运行
    steps:
      - name: Require manual approval
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait indefinitely for user approval
        run: |
          echo "Waiting for manual approval..."
          while true; do sleep 3600; done  # 无限等待

  push_image:
    name: Push Image
    runs-on: ubuntu-latest
    needs: wait_for_approval
    steps:
      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_HUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

      - name: Push image
        run: |
          docker push zengemily79/book_store:${{ github.sha }}
          docker push zengemily79/book_store:latest
